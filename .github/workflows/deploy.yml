name: Deploy to AWS

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  NODE_VERSION: '20'
  AWS_REGION: us-east-1
  S3_BUCKET: meltwater-replica-frontend-1766738866
  CLOUDFRONT_DISTRIBUTION_ID: ECXIM39VXV6PS
  EC2_INSTANCE_ID: i-01ddeb7146a111920
  BACKEND_CLOUDFRONT_URL: https://d1z2tovkx40jvd.cloudfront.net

jobs:
  # Run tests first
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install frontend dependencies
        run: npm install

      - name: Install backend dependencies
        run: cd backend && npm install

      - name: Lint frontend
        run: npm run lint
        continue-on-error: true

      - name: Build frontend
        run: npm run build
        env:
          VITE_API_URL: ${{ env.BACKEND_CLOUDFRONT_URL }}
          VITE_SOCKET_URL: ${{ env.BACKEND_CLOUDFRONT_URL }}

      - name: Build backend
        run: cd backend && npm run build

      - name: Run backend tests
        run: cd backend && npm run test:ci
        env:
          NODE_ENV: test
          JWT_SECRET: test-jwt-secret
          JWT_REFRESH_SECRET: test-jwt-refresh-secret

  # Deploy frontend to S3 + CloudFront
  deploy-frontend:
    name: Deploy Frontend
    runs-on: ubuntu-latest
    needs: [test]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Build frontend for production
        run: npm run build
        env:
          VITE_API_URL: ${{ env.BACKEND_CLOUDFRONT_URL }}
          VITE_SOCKET_URL: ${{ env.BACKEND_CLOUDFRONT_URL }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy to S3
        run: |
          aws s3 sync dist/ s3://${{ env.S3_BUCKET }} --delete \
            --cache-control "public, max-age=31536000, immutable" \
            --exclude "index.html" \
            --exclude "*.json"
          
          # Upload index.html and JSON files with no-cache
          aws s3 cp dist/index.html s3://${{ env.S3_BUCKET }}/index.html \
            --cache-control "no-cache, no-store, must-revalidate"
          
          # Upload any JSON files with short cache
          find dist -name "*.json" -exec aws s3 cp {} s3://${{ env.S3_BUCKET }}/{} \
            --cache-control "public, max-age=300" \; 2>/dev/null || true

      - name: Invalidate CloudFront cache
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ env.CLOUDFRONT_DISTRIBUTION_ID }} \
            --paths "/*"

      - name: Deployment complete
        run: |
          echo "Frontend deployed to https://d1csa5xsrjp1si.cloudfront.net"

  # Deploy backend to EC2 via SSM
  deploy-backend:
    name: Deploy Backend
    runs-on: ubuntu-latest
    needs: [test]
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy backend via SSM
        run: |
          # Send deployment command to EC2 via SSM
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids ${{ env.EC2_INSTANCE_ID }} \
            --document-name "AWS-RunShellScript" \
            --parameters 'commands=[
              "cd /home/ubuntu/arica-insights-builder || cd /home/ec2-user/arica-insights-builder || exit 1",
              "git fetch origin main",
              "git reset --hard origin/main",
              "cd backend",
              "npm ci --production",
              "npm run build",
              "pm2 restart arica-backend || pm2 start dist/server.js --name arica-backend",
              "pm2 save"
            ]' \
            --timeout-seconds 300 \
            --output text \
            --query 'Command.CommandId')
          
          echo "SSM Command ID: $COMMAND_ID"
          
          # Wait for command to complete
          aws ssm wait command-executed \
            --command-id "$COMMAND_ID" \
            --instance-id ${{ env.EC2_INSTANCE_ID }} || true
          
          # Get command output
          aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id ${{ env.EC2_INSTANCE_ID }} \
            --query '[Status, StandardOutputContent, StandardErrorContent]' \
            --output text

      - name: Verify backend health
        run: |
          echo "Waiting for backend to start..."
          sleep 10
          
          # Check health endpoint
          curl -f ${{ env.BACKEND_CLOUDFRONT_URL }}/health || echo "Health check pending - CloudFront may need time to propagate"

      - name: Deployment complete
        run: |
          echo "Backend deployed to ${{ env.BACKEND_CLOUDFRONT_URL }}"
